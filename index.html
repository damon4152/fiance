<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>金融程式整合小遊戲</title>
  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#1d4ed8;
      --primary2:#2563eb;
      --danger:#b91c1c;
      --success:#047857;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.10);
      --shadow2: 0 6px 20px rgba(15, 23, 42, 0.08);
      --radius: 14px;
      --radius2: 10px;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
    }
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, var(--primary), #0b3aa8);
      color:#fff;
      padding: 16px 18px;
      box-shadow: var(--shadow2);
    }
    header .wrap{
      max-width: 1120px;
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:baseline;
      justify-content:space-between;
    }
    header h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    header p{
      margin:0;
      font-size: 12px;
      opacity:.88;
    }

    .container{
      max-width: 1120px;
      margin: 16px auto 48px;
      padding: 0 16px;
    }

    /* tabs */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 14px 0 14px;
    }
    .tab-btn{
      border:1px solid rgba(255,255,255,.0);
      padding: 10px 14px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #111827;
      cursor:pointer;
      font-size: 14px;
      transition: transform .06s ease, background .15s ease, color .15s ease;
      user-select:none;
    }
    .tab-btn:hover{ transform: translateY(-1px); }
    .tab-btn.active{
      background: #0b3aa8;
      color:#fff;
      box-shadow: 0 8px 20px rgba(29,78,216,.25);
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(229,231,235,.7);
      border-radius: var(--radius);
      padding: 16px 16px;
      box-shadow: var(--shadow2);
      margin-bottom: 14px;
    }

    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }

    h2{
      margin:0;
      font-size: 18px;
      color: var(--text);
      letter-spacing: .2px;
    }
    h3{
      margin: 16px 0 8px;
      font-size: 14px;
      color: var(--text);
      letter-spacing: .1px;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      margin: 6px 0 0;
    }

    .pill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: var(--primary2);
      font-size: 11px;
      border: 1px solid rgba(37,99,235,.15);
      vertical-align: middle;
    }

    /* forms */
    label{
      display:block;
      font-size: 12px;
      color: #374151;
      margin-bottom: 5px;
    }
    input, textarea, select{
      width:100%;
      font-family:inherit;
      font-size: 13px;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    textarea{ resize: vertical; min-height: 82px; }

    .grid{
      display:grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .col-3{ grid-column: span 3; }
    .col-4{ grid-column: span 4; }
    .col-6{ grid-column: span 6; }
    .col-12{ grid-column: span 12; }

    @media (max-width: 980px){
      .col-3{ grid-column: span 6; }
      .col-4{ grid-column: span 6; }
      .col-6{ grid-column: span 12; }
    }
    @media (max-width: 560px){
      .col-3,.col-4{ grid-column: span 12; }
      header .wrap{ align-items:flex-start; }
    }

    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .btn{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(29,78,216,.0);
      background: var(--primary);
      color:#fff;
      cursor:pointer;
      font-size: 13px;
      transition: transform .06s ease, box-shadow .15s ease, opacity .15s ease, background .15s ease;
      box-shadow: 0 10px 20px rgba(29,78,216,.22);
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: #1646c7; }
    .btn:disabled{ opacity:.5; cursor: not-allowed; transform:none; box-shadow:none; }
    .btn.ghost{
      background:#fff;
      color: var(--primary);
      border: 1px solid rgba(29,78,216,.22);
      box-shadow:none;
    }
    .btn.ghost:hover{ background:#eff6ff; }

    .alert{
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(229,231,235,.9);
      background: #f9fafb;
      color: #111827;
      font-size: 13px;
      margin-top: 10px;
      display:none;
    }
    .alert.show{ display:block; }
    .alert.danger{
      border-color: rgba(185, 28, 28, .20);
      background: rgba(185, 28, 28, .06);
      color: #7f1d1d;
    }
    .alert.success{
      border-color: rgba(4, 120, 87, .20);
      background: rgba(4, 120, 87, .06);
      color: #064e3b;
    }

    .stat{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .stat .item{
      grid-column: span 3;
      border: 1px solid rgba(229,231,235,.9);
      border-radius: 12px;
      padding: 10px 10px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    }
    .stat .k{ font-size: 12px; color: var(--muted); }
    .stat .v{ font-size: 16px; font-weight: 700; margin-top: 2px; }
    @media (max-width: 980px){ .stat .item{ grid-column: span 6; } }
    @media (max-width: 560px){ .stat .item{ grid-column: span 12; } }

    /* tables */
    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius: 12px;
      border: 1px solid rgba(229,231,235,.9);
      background:#fff;
      margin-top: 10px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 760px;
    }
    th,td{
      border-bottom: 1px solid rgba(229,231,235,.9);
      padding: 8px 10px;
      text-align:right;
      white-space: nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background: #f3f4f6;
      font-weight: 700;
      color:#111827;
      z-index: 1;
    }
    td:first-child, th:first-child{ text-align:left; }
    .neg{ color: var(--danger); font-weight: 700; }
    .pos{ color: var(--success); font-weight: 700; }

    .section{ display:none; }
    .section.active{ display:block; }

    .split{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .radio-line, .check-line{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 8px 0 0;
      font-size: 13px;
    }
    .radio-line label, .check-line label{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0;
      font-size: 13px;
      color:#111827;
    }
    input[type="radio"], input[type="checkbox"]{
      width:auto;
      margin:0;
      accent-color: var(--primary);
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div>
      <h1>金融程式整合小遊戲</h1>
      <p>把「股利投資 / 收支事件 / 保險 + 貸款」整合成同一個可用網頁</p>
    </div>
    <p class="mono" style="opacity:.9;">v2.0（美化 + 補齊功能 + 可匯出/可保存）</p>
  </div>
</header>

<div class="container">
  <div class="tabs" role="tablist" aria-label="模組切換">
    <button class="tab-btn active" data-target="module-invest" role="tab" aria-selected="true">股利／投資模擬</button>
    <button class="tab-btn" data-target="module-budget" role="tab" aria-selected="false">收支配置＋事件</button>
    <button class="tab-btn" data-target="module-insurance" role="tab" aria-selected="false">保險＋貸款</button>
  </div>

  <!-- ========== 模組一：投資 ========== -->
  <section id="module-invest" class="section active">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>股利／投資模擬</h2>
          <p class="small">
            你原本版本用「年報酬率序列」直接計算資產成長，等同使用「總報酬率（Total Return）」概念。
            新版保留這條路，並新增「股價成長 + 股利殖利率 + 再投入」模式（更接近存股實務）。
          </p>
        </div>
        <span class="pill">設定會自動保存</span>
      </div>

      <div class="grid">
        <div class="col-3">
          <label>股票代號（顯示用）</label>
          <select id="inv-stock">
            <option value="2330">2330</option>
            <option value="2603">2603</option>
            <option value="2882">2882</option>
            <option value="0050">0050</option>
            <option value="other" selected>其他／自訂</option>
          </select>
        </div>

        <div class="col-3">
          <label>投資期間（年）</label>
          <input id="inv-years" type="number" min="1" value="10" />
        </div>

        <div class="col-6">
          <label>投入方式</label>
          <div class="radio-line">
            <label><input type="radio" name="inv-mode" value="lumpsum" checked /> 一次性投入</label>
            <label><input type="radio" name="inv-mode" value="annual" /> 每年固定金額</label>
          </div>
          <div class="grid" style="margin-top:10px;">
            <div class="col-6">
              <label>一次投入金額</label>
              <input id="inv-lumpsum" type="number" min="0" value="100000" />
            </div>
            <div class="col-6">
              <label>每年投入金額</label>
              <input id="inv-annual" type="number" min="0" value="10000" />
            </div>
          </div>
        </div>
      </div>

      <h3>計算模式（重要）</h3>
      <div class="grid">
        <div class="col-6">
          <label>模式 A：總報酬率序列（含息報酬/你已把股利揉進去） <span class="pill">沿用原本邏輯</span></label>
          <textarea id="inv-returns" placeholder="例如：0.08,0.05,0.03,-0.02,0.1">0.08,0.05,0.03,-0.02,0.1</textarea>
          <div class="hint">用在：你已經有「總報酬率」資料（股價變動 + 股利再投入 + 其他都算進去）。</div>
        </div>

        <div class="col-6">
          <label>模式 B：股價成長率 + 股利殖利率（較貼近實務）</label>
          <div class="grid">
            <div class="col-6">
              <label>起始股價</label>
              <input id="inv-start-price" type="number" min="0" value="100" />
            </div>
            <div class="col-6">
              <label>是否股利再投入</label>
              <select id="inv-reinvest">
                <option value="yes" selected>是（DRIP）</option>
                <option value="no">否（股利領現）</option>
              </select>
            </div>
            <div class="col-6">
              <label>年股價成長率序列（小數, 逗號）</label>
              <input id="inv-growth" type="text" value="0.06,0.04,0.02,-0.03,0.08" />
            </div>
            <div class="col-6">
              <label>年股利殖利率序列（小數, 逗號）</label>
              <input id="inv-divy" type="text" value="0.03,0.03,0.035,0.04,0.03" />
            </div>
            <div class="col-6">
              <label>股利稅/費（簡化%）</label>
              <input id="inv-div-tax" type="number" step="0.1" value="0" />
              <div class="hint">例如填 10 代表扣 10%（簡化）。若你要完全照台股稅制，之後可再擴充。</div>
            </div>
            <div class="col-6">
              <label>交易成本（再投入時，簡化%）</label>
              <input id="inv-fee" type="number" step="0.01" value="0" />
              <div class="hint">例如填 0.1425 代表手續費 0.1425%（示意）。</div>
            </div>
          </div>

          <div class="hint">
            ⚠️ 注意：若你 Excel 用的是「每股股利 DPS」而不是「殖利率」，請把程式碼中 <span class="mono">dividend = value * divYield</span> 改成 <span class="mono">dividend = shares * dps</span>（我在 JS 裡有標註位置）。
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="runInvestment()">計算投資結果</button>
        <button class="btn ghost" onclick="resetInvest()">重設投資輸入</button>
      </div>
      <div id="inv-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat" style="margin-top:12px;">
        <div class="item">
          <div class="k">投入成本</div>
          <div class="v" id="inv-total-invest">-</div>
        </div>
        <div class="item">
          <div class="k">最終財富</div>
          <div class="v" id="inv-final-wealth">-</div>
        </div>
        <div class="item">
          <div class="k">累積報酬率</div>
          <div class="v" id="inv-total-return">-</div>
        </div>
        <div class="item">
          <div class="k">年化報酬率（幾何）</div>
          <div class="v" id="inv-annual-return">-</div>
        </div>
      </div>

      <div class="hint" style="margin-top:10px;">
        ✅ 你要「完全對齊 Excel」：你需要把 Excel 中「股利計算（含稅/補充保費/手續費/股數變動）」的欄位規則給我，我就能把模式 B 的計算改成 100% 同步。
      </div>
    </div>
  </section>

  <!-- ========== 模組二：收支 + 事件 ========== -->
  <section id="module-budget" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>收支配置＋生活事件小遊戲</h2>
          <p class="small">
            新版把你的「百分比分配」補齊：每回合視為 1 個月，先入帳收入，再依比例分桶；事件會影響現金並記錄。
          </p>
        </div>
        <span class="pill">可匯出 CSV</span>
      </div>

      <h3>基本設定</h3>
      <div class="grid">
        <div class="col-3">
          <label>每月收入（元）</label>
          <input id="budget-income" type="number" min="0" value="65000" />
        </div>
        <div class="col-3">
          <label>民生必需品 %</label>
          <input id="pct-necessities" type="number" min="0" max="100" value="30" />
        </div>
        <div class="col-3">
          <label>緊急預備金 %</label>
          <input id="pct-emergency" type="number" min="0" max="100" value="20" />
        </div>
        <div class="col-3">
          <label>娛樂支出 %</label>
          <input id="pct-entertainment" type="number" min="0" max="100" value="10" />
        </div>
        <div class="col-3">
          <label>投資 %</label>
          <input id="pct-invest" type="number" min="0" max="100" value="20" />
        </div>
        <div class="col-3">
          <label>起始現金（可選）</label>
          <input id="budget-start-cash" type="number" min="0" value="65000" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" id="budget-start-btn" onclick="startBudgetGame()">開始新遊戲</button>
        <button class="btn" id="budget-next-btn" onclick="nextBudgetTurn()" disabled>下一回合（1 個月）</button>
        <button class="btn ghost" onclick="clearBudgetLog()">清除紀錄</button>
        <button class="btn ghost" onclick="exportBudgetCSV()">匯出 CSV</button>
      </div>
      <div id="budget-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat">
        <div class="item">
          <div class="k">回合數</div>
          <div class="v" id="budget-turn">-</div>
        </div>
        <div class="item">
          <div class="k">現金餘額</div>
          <div class="v" id="budget-cash">-</div>
        </div>
        <div class="item">
          <div class="k">必需品累積</div>
          <div class="v" id="bucket-necessities">-</div>
        </div>
        <div class="item">
          <div class="k">緊急預備金累積</div>
          <div class="v" id="bucket-emergency">-</div>
        </div>
        <div class="item">
          <div class="k">娛樂累積</div>
          <div class="v" id="bucket-entertainment">-</div>
        </div>
        <div class="item">
          <div class="k">投資累積</div>
          <div class="v" id="bucket-invest">-</div>
        </div>
        <div class="item">
          <div class="k">其他累積</div>
          <div class="v" id="bucket-other">-</div>
        </div>
      </div>

      <h3>事件紀錄</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>回合</th>
              <th>月收入入帳</th>
              <th>分配（必需/緊急/娛樂/投資/其他）</th>
              <th>事件</th>
              <th>事件金額</th>
              <th>回合後現金</th>
              <th>說明</th>
            </tr>
          </thead>
          <tbody id="budget-log-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========== 模組三：保險 + 貸款 ========== -->
  <section id="module-insurance" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>保險小遊戲（保費 vs 理賠/自付）</h2>
          <p class="small">
            新增「沒保險時的事故成本（自付）」欄位，讓情境更接近現實。
          </p>
        </div>
        <span class="pill">可匯出 CSV</span>
      </div>

      <h3>參數</h3>
      <div class="grid">
        <div class="col-3">
          <label>起始現金</label>
          <input id="ins-start-cash" type="number" value="120000" />
        </div>
        <div class="col-3">
          <label>起始年齡</label>
          <input id="ins-start-age" type="number" value="24" />
        </div>
        <div class="col-3">
          <label>總回合（年）</label>
          <input id="ins-max-turns" type="number" value="15" />
        </div>
      </div>

      <div class="grid" style="margin-top:8px;">
        <div class="col-3">
          <h3>保費 Prem</h3>
          <label>壽險保費</label><input id="ins-prem-life" type="number" value="6000" />
          <label>醫療保費</label><input id="ins-prem-medical" type="number" value="4500" />
          <label>財產保費</label><input id="ins-prem-property" type="number" value="3000" />
        </div>
        <div class="col-3">
          <h3>事故機率 Prob</h3>
          <label>壽險</label><input id="ins-prob-life" type="number" step="0.01" value="0.01" />
          <label>醫療</label><input id="ins-prob-medical" type="number" step="0.01" value="0.12" />
          <label>財產</label><input id="ins-prob-property" type="number" step="0.01" value="0.06" />
        </div>
        <div class="col-3">
          <h3>理賠 Payout</h3>
          <label>壽險理賠</label><input id="ins-payout-life" type="number" value="500000" />
          <label>醫療理賠</label><input id="ins-payout-medical" type="number" value="50000" />
          <label>財產理賠</label><input id="ins-payout-property" type="number" value="120000" />
        </div>
        <div class="col-3">
          <h3>沒保險自付成本（事故發生時）</h3>
          <label>壽險事故成本</label><input id="ins-costno-life" type="number" value="300000" />
          <label>醫療事故成本</label><input id="ins-costno-medical" type="number" value="30000" />
          <label>財產事故成本</label><input id="ins-costno-property" type="number" value="80000" />
          <div class="hint">若你 Excel 有「自付額/免賠額」等規則，也能再擴充。</div>
        </div>
      </div>

      <div class="check-line" style="margin-top:8px;">
        <label><input type="checkbox" id="ins-has-life" checked /> 投保壽險</label>
        <label><input type="checkbox" id="ins-has-medical" checked /> 投保醫療險</label>
        <label><input type="checkbox" id="ins-has-property" checked /> 投保財產險</label>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="startInsGame()">開始新遊戲</button>
        <button class="btn" id="ins-next-btn" onclick="nextInsTurn()" disabled>下一回合</button>
        <button class="btn ghost" onclick="clearInsLog()">清除紀錄</button>
        <button class="btn ghost" onclick="exportInsCSV()">匯出 CSV</button>
      </div>
      <div id="ins-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat">
        <div class="item"><div class="k">年齡</div><div class="v" id="ins-age">-</div></div>
        <div class="item"><div class="k">回合</div><div class="v" id="ins-turn">-</div></div>
        <div class="item"><div class="k">現金餘額</div><div class="v" id="ins-cash">-</div></div>
        <div class="item"><div class="k">累積保費</div><div class="v" id="ins-total-prem">-</div></div>
        <div class="item"><div class="k">累積理賠</div><div class="v" id="ins-total-payout">-</div></div>
        <div class="item"><div class="k">累積自付（沒保險）</div><div class="v" id="ins-total-outofpocket">-</div></div>
      </div>

      <h3>事件紀錄</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>回合</th>
              <th>年齡</th>
              <th>保費支出</th>
              <th>理賠收入</th>
              <th>沒保險自付</th>
              <th>事故說明</th>
              <th>回合後現金</th>
            </tr>
          </thead>
          <tbody id="ins-log-body"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <h2>貸款攤還表試算</h2>
          <p class="small">支援利率 0% 情境；最後一期補差更嚴謹，避免浮點誤差。</p>
        </div>
        <span class="pill">可直接複製回 Excel</span>
      </div>

      <div class="grid">
        <div class="col-3">
          <label>貸款本金</label>
          <input id="loan-principal" type="number" value="500000" />
        </div>
        <div class="col-3">
          <label>貸款年利率（%）</label>
          <input id="loan-rate" type="number" step="0.01" value="2" />
        </div>
        <div class="col-3">
          <label>貸款年限（年）</label>
          <input id="loan-years" type="number" value="15" />
        </div>
        <div class="col-3">
          <label>每年付款次數</label>
          <input id="loan-nperyear" type="number" value="12" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" onclick="calcLoan()">計算攤還表</button>
        <button class="btn ghost" onclick="clearLoan()">清除</button>
      </div>
      <div id="loan-alert" class="alert" role="alert" aria-live="polite"></div>

      <div class="stat">
        <div class="item"><div class="k">每期應付金額</div><div class="v" id="loan-payment">-</div></div>
        <div class="item"><div class="k">總支付利息</div><div class="v" id="loan-total-interest">-</div></div>
        <div class="item"><div class="k">總還款金額</div><div class="v" id="loan-total-paid">-</div></div>
      </div>

      <h3>攤還明細</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>期數</th>
              <th>每期付款</th>
              <th>本金</th>
              <th>利息</th>
              <th>剩餘本金</th>
            </tr>
          </thead>
          <tbody id="loan-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
  /* =========================
     共用工具
  ========================= */
  const LS_KEY = "finance_game_v2_state";

  function formatMoney(num){
    if (num === null || num === undefined || isNaN(num)) return "-";
    return Number(num).toLocaleString("zh-TW", { maximumFractionDigits: 2 });
  }
  function parseNumberById(id){
    const v = parseFloat(document.getElementById(id).value);
    return isNaN(v) ? 0 : v;
  }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function showAlert(id, msg, type="danger"){
    const el = document.getElementById(id);
    el.className = "alert show " + (type === "success" ? "success" : "danger");
    el.textContent = msg;
  }
  function hideAlert(id){
    const el = document.getElementById(id);
    el.className = "alert";
    el.textContent = "";
  }

  function toCSV(rows){
    const esc = (s) => {
      const str = String(s ?? "");
      if (/[",\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
      return str;
    };
    return rows.map(r => r.map(esc).join(",")).join("\n");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /* =========================
     Tabs（含 hash）
  ========================= */
  const tabBtns = document.querySelectorAll(".tab-btn");
  const sections = document.querySelectorAll(".section");

  function activateTab(targetId){
    tabBtns.forEach(b => {
      const active = b.dataset.target === targetId;
      b.classList.toggle("active", active);
      b.setAttribute("aria-selected", active ? "true" : "false");
    });
    sections.forEach(sec => sec.classList.toggle("active", sec.id === targetId));
    location.hash = targetId;
  }

  tabBtns.forEach(btn=>{
    btn.addEventListener("click", ()=> activateTab(btn.dataset.target));
  });

  // 初始 hash
  if (location.hash){
    const id = location.hash.replace("#","");
    if (document.getElementById(id)) activateTab(id);
  }

  /* =========================
     localStorage：保存/還原
  ========================= */
  const watchIds = [
    // invest
    "inv-stock","inv-years","inv-lumpsum","inv-annual","inv-returns",
    "inv-start-price","inv-reinvest","inv-growth","inv-divy","inv-div-tax","inv-fee",
    // budget
    "budget-income","pct-necessities","pct-emergency","pct-entertainment","pct-invest","budget-start-cash",
    // insurance
    "ins-start-cash","ins-start-age","ins-max-turns",
    "ins-prem-life","ins-prem-medical","ins-prem-property",
    "ins-prob-life","ins-prob-medical","ins-prob-property",
    "ins-payout-life","ins-payout-medical","ins-payout-property",
    "ins-costno-life","ins-costno-medical","ins-costno-property",
    "ins-has-life","ins-has-medical","ins-has-property",
    // loan
    "loan-principal","loan-rate","loan-years","loan-nperyear"
  ];

  function saveState(){
    const data = {};
    watchIds.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === "checkbox") data[id] = el.checked;
      else data[id] = el.value;
    });
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }
  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    try{
      const data = JSON.parse(raw);
      Object.keys(data).forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === "checkbox") el.checked = !!data[id];
        else el.value = data[id];
      });
    }catch(e){}
  }

  loadState();
  watchIds.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", saveState);
    el.addEventListener("change", saveState);
  });

  /* =========================
     模組一：投資
  ========================= */
  function parseSeries(text){
    return String(text || "")
      .split(",")
      .map(s => parseFloat(s.trim()))
      .filter(v => !isNaN(v));
  }

  function runInvestment(){
    hideAlert("inv-alert");
    const years = parseInt(document.getElementById("inv-years").value, 10) || 0;
    if (years <= 0){
      showAlert("inv-alert","投資期間請輸入正整數。");
      return;
    }

    const mode = document.querySelector('input[name="inv-mode"]:checked').value;
    const lump = parseNumberById("inv-lumpsum");
    const annual = parseNumberById("inv-annual");

    if (mode === "lumpsum" && lump <= 0){
      showAlert("inv-alert","一次性投入金額需大於 0。");
      return;
    }
    if (mode === "annual" && annual <= 0){
      showAlert("inv-alert","每年投入金額需大於 0。");
      return;
    }

    // 兩種計算模式：A（總報酬率）或 B（股價+股利）
    const returnsA = parseSeries(document.getElementById("inv-returns").value);
    const startPrice = parseNumberById("inv-start-price");
    const growth = parseSeries(document.getElementById("inv-growth").value);
    const divy = parseSeries(document.getElementById("inv-divy").value);

    // 判斷使用模式：如果 B 的起始股價>0 且 growth/divy 至少有一個有效，就用 B；否則用 A
    const useB = (startPrice > 0) && (growth.length > 0 || divy.length > 0);

    let totalInvest = 0;
    let finalWealth = 0;

    if (!useB){
      // ===== 模式 A：總報酬率（沿用你原本概念）=====
      if (returnsA.length === 0){
        showAlert("inv-alert","模式 A：請至少輸入一個年報酬率序列（例如 0.08,0.05,...）。");
        return;
      }
      let wealth = 0;

      if (mode === "lumpsum"){
        totalInvest = lump;
        wealth = lump;
        for (let i=0;i<years;i++){
          const r = returnsA[Math.min(i, returnsA.length-1)];
          wealth *= (1 + r);
        }
      }else{
        wealth = 0;
        totalInvest = 0;
        for (let i=0;i<years;i++){
          const r = returnsA[Math.min(i, returnsA.length-1)];
          wealth = (wealth + annual) * (1 + r);
          totalInvest += annual;
        }
      }
      finalWealth = wealth;

    }else{
      // ===== 模式 B：股價成長 + 股利殖利率（更貼近實務）=====
      // 這裡把「股利」拆出來；若要改成 DPS，每股股利請看註解。
      const reinvest = document.getElementById("inv-reinvest").value === "yes";
      const divTax = clamp(parseNumberById("inv-div-tax") / 100, 0, 1); // 簡化稅/費
      const fee = clamp(parseNumberById("inv-fee") / 100, 0, 1);        // 簡化交易成本
      let price = startPrice;
      let shares = 0;
      let cashDividend = 0;

      function applyContribution(amount){
        // 以當下股價買入（簡化，不含交易稅等；如需可加）
        if (amount <= 0) return;
        const buyable = amount * (1 - fee); // 簡化：用 fee 當作買入成本
        shares += buyable / price;
        totalInvest += amount;
      }

      if (mode === "lumpsum") applyContribution(lump);

      for (let i=0;i<years;i++){
        if (mode === "annual") applyContribution(annual);

        const g = growth.length ? growth[Math.min(i, growth.length-1)] : 0;
        const dy = divy.length ? divy[Math.min(i, divy.length-1)] : 0;

        // 先股價成長（假設一年後）
        price = price * (1 + g);

        // 發放股利（簡化：用殖利率 * 市值）
        const value = shares * price;

        // ★ 若你要改「每股股利 DPS」：把下一行改成  shares * dps
        // const dividend = shares * dps;
        const dividend = value * dy;

        const netDividend = dividend * (1 - divTax);

        if (reinvest){
          // 股利再投入（用當年期末價買）
          const buyable = netDividend * (1 - fee);
          shares += buyable / price;
        }else{
          // 領現金
          cashDividend += netDividend;
        }
      }

      finalWealth = shares * price + cashDividend;
      if (totalInvest <= 0){
        showAlert("inv-alert","投入成本為 0，無法計算報酬率。");
        return;
      }
    }

    const totalReturn = finalWealth / totalInvest - 1;
    const annualReturn = Math.pow(1 + totalReturn, 1 / years) - 1;

    document.getElementById("inv-total-invest").textContent = formatMoney(totalInvest);
    document.getElementById("inv-final-wealth").textContent = formatMoney(finalWealth);
    document.getElementById("inv-total-return").textContent = (totalReturn * 100).toFixed(2) + "%";
    document.getElementById("inv-annual-return").textContent = (annualReturn * 100).toFixed(2) + "%";

    showAlert("inv-alert", `已完成計算（使用 ${useB ? "模式 B：股價+股利" : "模式 A：總報酬率"}）。`, "success");
  }

  function resetInvest(){
    document.getElementById("inv-years").value = 10;
    document.getElementById("inv-lumpsum").value = 100000;
    document.getElementById("inv-annual").value = 10000;
    document.getElementById("inv-returns").value = "0.08,0.05,0.03,-0.02,0.1";
    document.getElementById("inv-start-price").value = 100;
    document.getElementById("inv-reinvest").value = "yes";
    document.getElementById("inv-growth").value = "0.06,0.04,0.02,-0.03,0.08";
    document.getElementById("inv-divy").value = "0.03,0.03,0.035,0.04,0.03";
    document.getElementById("inv-div-tax").value = 0;
    document.getElementById("inv-fee").value = 0;
    ["inv-total-invest","inv-final-wealth","inv-total-return","inv-annual-return"]
      .forEach(id=> document.getElementById(id).textContent = "-");
    hideAlert("inv-alert");
    saveState();
  }

  /* =========================
     模組二：收支 + 事件
  ========================= */
  const budgetEvents = [
    { name: "家中洗衣機壞掉", delta: -8000, desc: "必需品開支增加，得換新洗衣機。" },
    { name: "通貨膨脹情境", delta: -3000, desc: "物價上漲，生活成本提高。" },
    { name: "中樂透", delta: 100000, desc: "一次性大量收入。" },
    { name: "公司尾牙抽中十萬", delta: 100000, desc: "尾牙抽獎中的獎金。" },
    { name: "突發車禍賠款", delta: -50000, desc: "車禍需要賠償與修車費用。" },
    { name: "教育費臨時增加", delta: -10000, desc: "臨時加收費用。" },
    { name: "水電費加收", delta: -3000, desc: "水電費用突然增加。" },
    { name: "醫療保健支出增加", delta: -8000, desc: "家人身體不適，需要額外醫療支出。" },
    { name: "股票小漲", delta: 5000, desc: "投資部位小幅獲利。" },
    { name: "股票小跌", delta: -5000, desc: "投資部位小幅虧損。" },
    { name: "朋友借款還你", delta: 10000, desc: "之前借出去的錢回來了。" },
    { name: "意外損失", delta: -6000, desc: "突發的小意外開銷。" },
    { name: "獎金入帳", delta: 20000, desc: "工作表現良好獲得獎金。" },
    { name: "旅行超支", delta: -13000, desc: "旅遊花費超出預期。" }
  ];

  let budgetState = null;

  function renderBuckets(){
    const b = budgetState.buckets;
    document.getElementById("bucket-necessities").textContent = formatMoney(b.necessities);
    document.getElementById("bucket-emergency").textContent = formatMoney(b.emergency);
    document.getElementById("bucket-entertainment").textContent = formatMoney(b.entertainment);
    document.getElementById("bucket-invest").textContent = formatMoney(b.invest);
    document.getElementById("bucket-other").textContent = formatMoney(b.other);
  }

  function startBudgetGame(){
    hideAlert("budget-alert");
    const income = parseNumberById("budget-income");
    const startCash = parseNumberById("budget-start-cash");
    if (income <= 0){
      showAlert("budget-alert","每月收入需大於 0。");
      return;
    }

    const pNec = clamp(parseNumberById("pct-necessities"), 0, 100);
    const pEmg = clamp(parseNumberById("pct-emergency"), 0, 100);
    const pEnt = clamp(parseNumberById("pct-entertainment"), 0, 100);
    const pInv = clamp(parseNumberById("pct-invest"), 0, 100);
    const sumP = pNec + pEmg + pEnt + pInv;
    if (sumP > 100){
      showAlert("budget-alert","各項投入百分比總和不可超過 100%。");
      return;
    }

    budgetState = {
      turn: 0,
      cash: startCash,
      income,
      percents: { necessities:pNec, emergency:pEmg, entertainment:pEnt, invest:pInv },
      buckets: { necessities:0, emergency:0, entertainment:0, invest:0, other:0 },
      log: []
    };

    document.getElementById("budget-turn").textContent = "0";
    document.getElementById("budget-cash").textContent = formatMoney(budgetState.cash);
    document.getElementById("budget-log-body").innerHTML = "";
    renderBuckets();

    document.getElementById("budget-start-btn").textContent = "重新開始";
    document.getElementById("budget-next-btn").disabled = false;

    showAlert("budget-alert","已開始新遊戲（每回合 = 1 個月）。", "success");
  }

  function nextBudgetTurn(){
    hideAlert("budget-alert");
    if (!budgetState){
      showAlert("budget-alert","請先按「開始新遊戲」。");
      return;
    }

    budgetState.turn += 1;

    // 1) 入帳收入
    budgetState.cash += budgetState.income;

    // 2) 分桶（從現金扣出，累積到桶）
    const inc = budgetState.income;
    const p = budgetState.percents;
    const nec = inc * p.necessities/100;
    const emg = inc * p.emergency/100;
    const ent = inc * p.entertainment/100;
    const inv = inc * p.invest/100;
    const other = inc - (nec + emg + ent + inv);

    budgetState.cash -= (nec + emg + ent + inv + other);

    budgetState.buckets.necessities += nec;
    budgetState.buckets.emergency += emg;
    budgetState.buckets.entertainment += ent;
    budgetState.buckets.invest += inv;
    budgetState.buckets.other += other;

    // 3) 事件
    const event = budgetEvents[Math.floor(Math.random()*budgetEvents.length)];
    budgetState.cash += event.delta;

    // 顯示
    document.getElementById("budget-turn").textContent = String(budgetState.turn);
    document.getElementById("budget-cash").textContent = formatMoney(budgetState.cash);
    renderBuckets();

    const allocationText = `${formatMoney(nec)} / ${formatMoney(emg)} / ${formatMoney(ent)} / ${formatMoney(inv)} / ${formatMoney(other)}`;

    // log
    const row = [
      budgetState.turn,
      formatMoney(budgetState.income),
      allocationText,
      event.name,
      (event.delta>=0?"+":"") + formatMoney(event.delta),
      formatMoney(budgetState.cash),
      event.desc
    ];
    budgetState.log.push(row);

    const tr = document.createElement("tr");
    row.forEach((v, idx)=>{
      const td = document.createElement("td");
      td.textContent = v;
      if (idx === 4){
        td.className = event.delta < 0 ? "neg" : "pos";
      }
      tr.appendChild(td);
    });
    document.getElementById("budget-log-body").appendChild(tr);
  }

  function clearBudgetLog(){
    if (!budgetState){
      document.getElementById("budget-log-body").innerHTML = "";
      hideAlert("budget-alert");
      return;
    }
    budgetState.log = [];
    document.getElementById("budget-log-body").innerHTML = "";
    showAlert("budget-alert","已清除收支事件紀錄。","success");
  }

  function exportBudgetCSV(){
    if (!budgetState || budgetState.log.length === 0){
      showAlert("budget-alert","目前沒有可匯出的紀錄。");
      return;
    }
    const header = [["回合","月收入入帳","分配(必需/緊急/娛樂/投資/其他)","事件","事件金額","回合後現金","說明"]];
    const csv = toCSV(header.concat(budgetState.log));
    downloadText("budget_log.csv", csv);
    showAlert("budget-alert","已匯出 budget_log.csv","success");
  }

  /* =========================
     模組三：保險
  ========================= */
  let insState = null;

  function startInsGame(){
    hideAlert("ins-alert");
    const cash = parseNumberById("ins-start-cash");
    const age = parseInt(document.getElementById("ins-start-age").value,10) || 0;
    const maxTurns = parseInt(document.getElementById("ins-max-turns").value,10) || 0;
    if (cash <= 0 || age <= 0 || maxTurns <= 0){
      showAlert("ins-alert","請確認起始現金、年齡與回合數皆為正數。");
      return;
    }

    insState = {
      age, turn: 0, maxTurns,
      cash,
      totalPrem: 0,
      totalPayout: 0,
      totalOut: 0,
      log: []
    };

    document.getElementById("ins-age").textContent = insState.age;
    document.getElementById("ins-turn").textContent = insState.turn;
    document.getElementById("ins-cash").textContent = formatMoney(insState.cash);
    document.getElementById("ins-total-prem").textContent = formatMoney(0);
    document.getElementById("ins-total-payout").textContent = formatMoney(0);
    document.getElementById("ins-total-outofpocket").textContent = formatMoney(0);
    document.getElementById("ins-log-body").innerHTML = "";
    document.getElementById("ins-next-btn").disabled = false;

    showAlert("ins-alert","已開始新遊戲。","success");
  }

  function nextInsTurn(){
    hideAlert("ins-alert");
    if (!insState){
      showAlert("ins-alert","請先按「開始新遊戲」。");
      return;
    }
    if (insState.turn >= insState.maxTurns){
      showAlert("ins-alert","已到達最大回合數。");
      document.getElementById("ins-next-btn").disabled = true;
      return;
    }

    const premLife = parseNumberById("ins-prem-life");
    const premMed  = parseNumberById("ins-prem-medical");
    const premProp = parseNumberById("ins-prem-property");

    const probLife = clamp(parseFloat(document.getElementById("ins-prob-life").value) || 0, 0, 1);
    const probMed  = clamp(parseFloat(document.getElementById("ins-prob-medical").value) || 0, 0, 1);
    const probProp = clamp(parseFloat(document.getElementById("ins-prob-property").value) || 0, 0, 1);

    const payoutLife = parseNumberById("ins-payout-life");
    const payoutMed  = parseNumberById("ins-payout-medical");
    const payoutProp = parseNumberById("ins-payout-property");

    const costNoLife = parseNumberById("ins-costno-life");
    const costNoMed  = parseNumberById("ins-costno-medical");
    const costNoProp = parseNumberById("ins-costno-property");

    const hasLife = document.getElementById("ins-has-life").checked;
    const hasMed  = document.getElementById("ins-has-medical").checked;
    const hasProp = document.getElementById("ins-has-property").checked;

    insState.turn += 1;
    insState.age += 1;

    let premThis = 0;
    let payoutThis = 0;
    let outThis = 0;
    let descs = [];

    if (hasLife) premThis += premLife;
    if (hasMed)  premThis += premMed;
    if (hasProp) premThis += premProp;

    insState.cash -= premThis;
    insState.totalPrem += premThis;

    // 事故判定：有保險 -> 理賠；沒保險 -> 自付成本
    const lifeHit = Math.random() < probLife;
    const medHit  = Math.random() < probMed;
    const propHit = Math.random() < probProp;

    if (lifeHit){
      if (hasLife){
        payoutThis += payoutLife;
        descs.push("壽險事故：理賠 " + formatMoney(payoutLife));
      }else{
        outThis += costNoLife;
        descs.push("壽險事故：自付 -" + formatMoney(costNoLife));
      }
    }
    if (medHit){
      if (hasMed){
        payoutThis += payoutMed;
        descs.push("醫療事故：理賠 " + formatMoney(payoutMed));
      }else{
        outThis += costNoMed;
        descs.push("醫療事故：自付 -" + formatMoney(costNoMed));
      }
    }
    if (propHit){
      if (hasProp){
        payoutThis += payoutProp;
        descs.push("財產事故：理賠 " + formatMoney(payoutProp));
      }else{
        outThis += costNoProp;
        descs.push("財產事故：自付 -" + formatMoney(costNoProp));
      }
    }
    if (!lifeHit && !medHit && !propHit){
      descs.push("本回合無事故發生");
    }

    insState.cash += payoutThis;
    insState.cash -= outThis;

    insState.totalPayout += payoutThis;
    insState.totalOut += outThis;

    document.getElementById("ins-age").textContent = insState.age;
    document.getElementById("ins-turn").textContent = insState.turn;
    document.getElementById("ins-cash").textContent = formatMoney(insState.cash);
    document.getElementById("ins-total-prem").textContent = formatMoney(insState.totalPrem);
    document.getElementById("ins-total-payout").textContent = formatMoney(insState.totalPayout);
    document.getElementById("ins-total-outofpocket").textContent = formatMoney(insState.totalOut);

    const row = [
      insState.turn,
      insState.age,
      "-" + formatMoney(premThis),
      "+" + formatMoney(payoutThis),
      "-" + formatMoney(outThis),
      descs.join("；"),
      formatMoney(insState.cash)
    ];
    insState.log.push(row);

    const tr = document.createElement("tr");
    row.forEach((v, idx)=>{
      const td = document.createElement("td");
      td.textContent = v;
      if (idx===2 && premThis>0) td.className="neg";
      if (idx===3 && payoutThis>0) td.className="pos";
      if (idx===4 && outThis>0) td.className="neg";
      tr.appendChild(td);
    });
    document.getElementById("ins-log-body").appendChild(tr);

    if (insState.turn >= insState.maxTurns){
      document.getElementById("ins-next-btn").disabled = true;
      showAlert("ins-alert","已到達最大回合數。","success");
    }
  }

  function clearInsLog(){
    if (!insState){
      document.getElementById("ins-log-body").innerHTML = "";
      hideAlert("ins-alert");
      return;
    }
    insState.log = [];
    document.getElementById("ins-log-body").innerHTML = "";
    showAlert("ins-alert","已清除保險事件紀錄。","success");
  }

  function exportInsCSV(){
    if (!insState || insState.log.length === 0){
      showAlert("ins-alert","目前沒有可匯出的紀錄。");
      return;
    }
    const header = [["回合","年齡","保費支出","理賠收入","沒保險自付","事故說明","回合後現金"]];
    const csv = toCSV(header.concat(insState.log));
    downloadText("insurance_log.csv", csv);
    showAlert("ins-alert","已匯出 insurance_log.csv","success");
  }

  /* =========================
     模組三：貸款
  ========================= */
  function calcLoan(){
    hideAlert("loan-alert");
    const principal = parseNumberById("loan-principal");
    const rateAnnual = (parseFloat(document.getElementById("loan-rate").value) || 0) / 100;
    const years = parseInt(document.getElementById("loan-years").value,10) || 0;
    const nperYear = parseInt(document.getElementById("loan-nperyear").value,10) || 0;

    if (principal <= 0 || years <= 0 || nperYear <= 0){
      showAlert("loan-alert","請確認本金、年限、每年付款次數皆為正數。");
      return;
    }
    if (rateAnnual < 0){
      showAlert("loan-alert","年利率不可為負數。");
      return;
    }

    const n = years * nperYear;
    const r = rateAnnual / nperYear;

    let payment = 0;
    if (r === 0){
      payment = principal / n;
    }else{
      payment = principal * r / (1 - Math.pow(1 + r, -n));
    }

    let balance = principal;
    let totalInterest = 0;
    const tbody = document.getElementById("loan-table-body");
    tbody.innerHTML = "";

    for (let i=1;i<=n;i++){
      const interest = balance * r;
      let principalPay = payment - interest;

      // 最後一期補差：把餘額清到 0
      if (i === n){
        principalPay = balance;
        payment = principalPay + interest; // 最後一期可能略不同（更貼近真實）
      }

      balance = balance - principalPay;
      if (balance < 1e-8) balance = 0;

      totalInterest += interest;

      const tr = document.createElement("tr");
      const cells = [
        i,
        formatMoney(payment),
        formatMoney(principalPay),
        formatMoney(interest),
        formatMoney(balance)
      ];
      cells.forEach(v=>{
        const td = document.createElement("td");
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    const totalPaid = principal + totalInterest;
    document.getElementById("loan-payment").textContent = formatMoney(payment);
    document.getElementById("loan-total-interest").textContent = formatMoney(totalInterest);
    document.getElementById("loan-total-paid").textContent = formatMoney(totalPaid);

    showAlert("loan-alert","已完成攤還表計算。","success");
  }

  function clearLoan(){
    document.getElementById("loan-table-body").innerHTML = "";
    document.getElementById("loan-payment").textContent = "-";
    document.getElementById("loan-total-interest").textContent = "-";
    document.getElementById("loan-total-paid").textContent = "-";
    hideAlert("loan-alert");
  }
</script>
</body>
</html>
